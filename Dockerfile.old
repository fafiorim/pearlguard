FROM node:18-alpine

WORKDIR /app

# Install OpenSSL for certificate generation
RUN apk add --no-cache openssl

# Copy package files
COPY package*.json ./

# Install Node.js dependencies
RUN npm ci --only=production

# Copy ClamAV scanner client
COPY clamav-scanner.js ./

# Copy application source
COPY server.js generate-cert.js start.sh ./
COPY middleware ./middleware
COPY public ./public

# Make scripts executable
RUN chmod +x start.sh

# Create uploads directory
RUN mkdir -p uploads

# Expose ports
EXPOSE 3000 3443

# Set environment variables
ENV NODE_ENV=production \
    SECURITY_MODE=logOnly \
    SCAN_METHOD=buffer \
    HTTP_PORT=3000 \
    HTTPS_PORT=3443 \
    CLAMAV_HOST=clamav \
    CLAMAV_PORT=3310

# Start the application
CMD ["./start.sh"]
